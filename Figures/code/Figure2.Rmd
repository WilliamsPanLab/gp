---
title: "FIgure2"
output: github_document
date: "2023-05-06"
---

```{r}
# figure 2
library(mgcv)
library(visreg)
library(gratia)
library(dplyr)
library(tidyr)
library(stringr)
library(data.table)
library(ggridges)
library(ggbeeswarm)
```

```{r}
# set functions

```

```{r}
# t-test plots
# Subset the data for males and females
girls <- masterdf$cbcl_scr_syn_totprob_r[masterdf$sex == "F"]
boys <- masterdf$cbcl_scr_syn_totprob_r[masterdf$sex == "M"]

# Create a combined data vector
data <- list(Girls = girls, Boys = boys)

# Create the boxplot
boxplot(data, col = c("#9589BF", "#EFC570"), ylab = expression(italic(p)))

# internalizing
girls <- masterdf$cbcl_scr_syn_internal_r[masterdf$sex == "F"]
boys <- masterdf$cbcl_scr_syn_internal_r[masterdf$sex == "M"]

# Create a combined data vector
data <- list(Girls = girls, Boys = boys)

# Create the boxplot
boxplot(data, col = c("#9589BF", "#EFC570"), ylab = "Internalizing")

# externalizing
girls <- masterdf$cbcl_scr_syn_external_r[masterdf$sex == "F"]
boys <- masterdf$cbcl_scr_syn_external_r[masterdf$sex == "M"]

# Create a combined data vector
data <- list(Girls = girls, Boys = boys)

# Create the boxplot
boxplot(data, col = c("#9589BF", "#EFC570"), ylab = "Externalizing")
```

```{r}
# equivalent plots for poverty
masterdf$income<-as.numeric(masterdf$income)
# note that poverty is defined as income < 5: https://collection3165.readthedocs.io/en/stable/recommendations/#2-the-bids-participants-files-and-matched-groups
masterdf$poverty=0
masterdf$poverty[masterdf$income<5]=1
masterdf$poverty=as.ordered(masterdf$poverty)
# Subset the data for males and females
poor <- masterdf$cbcl_scr_syn_totprob_r[masterdf$poverty == 1]
rich <- masterdf$cbcl_scr_syn_totprob_r[masterdf$poverty == 0]

# Create a combined data vector
data <- list(Below = poor, Above = rich)

# Create the boxplot
boxplot(data, col = c("#E38B73", "#80A4CC"), ylab = expression(italic(p)))

# internalizing
poor <- masterdf$cbcl_scr_syn_internal_r[masterdf$poverty == 1]
rich <- masterdf$cbcl_scr_syn_internal_r[masterdf$poverty == 0]

# Create a combined data vector
data <- list(Below = poor, Above = rich)

# Create the boxplot
boxplot(data, col = c("#E38B73", "#80A4CC"), ylab = "Internalizing")

# externalizing
poor <- masterdf$cbcl_scr_syn_external_r[masterdf$poverty == 1]
rich <- masterdf$cbcl_scr_syn_external_r[masterdf$poverty == 0]

# Create a combined data vector
data <- list(Below = poor, Above = rich)

# Create the boxplot
boxplot(data, col = c("#E38B73", "#80A4CC"), ylab = "Externalizing")

```











```{r}
# some manual calculation to compensate for geom_boxplot shortcomings

MinMeanSEMMax <- function(x) {
  v <- c(min(x), mean(x) - sd(x), mean(x), mean(x) + sd(x), max(x))
  names(v) <- c("ymin", "lower", "middle", "upper", "ymax")
  v
}

ggplot(data, aes(factor(group), value)) +
  stat_summary(fun.data=MinMeanSEMMax, geom="boxplot", colour="red") + 
  ggtitle("Boxplot: Min, Mean-1SEM, Mean, Mean+1SEM, Max")

```
```{r}
# load in fits
# load in derivatives
# plot F: p, int ext

```



















```{r}
#### TEMPORAL PRECEDENCE TABLE
library(mgcv)
# load temporal precedence data from SampleConstruction.Rmd
tpdf=OutDFTmpPrec

```

```{r}
# Load the "lavaan" package
library(lavaan)


# Define the model syntax for the cross-lagged panel analysis
model <- '
  # Autoregressive effects
  g.y ~ g.x
  cbcl_scr_syn_totprob_r.y ~ cbcl_scr_syn_totprob_r.x
  
  # Cross-lagged effects
  g.y ~ cbcl_scr_syn_totprob_r.x
  cbcl_scr_syn_totprob_r.y ~ g.x
  
  # Residual covariances
  g.x ~~ cbcl_scr_syn_totprob_r.x
  g.y ~~ cbcl_scr_syn_totprob_r.y
  
  # Residual variances
  g.x ~~ g.x
  g.y ~~ g.y
  cbcl_scr_syn_totprob_r.x ~~ cbcl_scr_syn_totprob_r.x
  cbcl_scr_syn_totprob_r.y ~~ cbcl_scr_syn_totprob_r.y
'

# Fit the model to the data using maximum likelihood estimation
pfit <- sem(model, data = tpdf)

# Define the model syntax for the cross-lagged panel analysis
model <- '
  # Autoregressive effects
  g.y ~ g.x
  cbcl_scr_syn_internal_r.y ~ cbcl_scr_syn_internal_r.x
  
  # Cross-lagged effects
  g.y ~ cbcl_scr_syn_internal_r.x
  cbcl_scr_syn_internal_r.y ~ g.x
  
  # Residual covariances
  g.x ~~ cbcl_scr_syn_internal_r.x
  g.y ~~ cbcl_scr_syn_internal_r.y
  
  # Residual variances
  g.x ~~ g.x
  g.y ~~ g.y
  cbcl_scr_syn_internal_r.x ~~ cbcl_scr_syn_internal_r.x
  cbcl_scr_syn_internal_r.y ~~ cbcl_scr_syn_internal_r.y
'

# Fit the model to the data using maximum likelihood estimation
ifit <- sem(model, data = tpdf)

# Define the model syntax for the cross-lagged panel analysis
model <- '
  # Autoregressive effects
  g.y ~ g.x
  cbcl_scr_syn_external_r.y ~ cbcl_scr_syn_external_r.x
  
  # Cross-lagged effects
  g.y ~ cbcl_scr_syn_external_r.x
  cbcl_scr_syn_external_r.y ~ g.x
  
  # Residual covariances
  g.x ~~ cbcl_scr_syn_external_r.x
  g.y ~~ cbcl_scr_syn_external_r.y
  
  # Residual variances
  # note this tracks concurrent increases in outcome variables
  g.x ~~ g.x
  g.y ~~ g.y
  cbcl_scr_syn_external_r.x ~~ cbcl_scr_syn_external_r.x
  cbcl_scr_syn_external_r.y ~~ cbcl_scr_syn_external_r.y
'

# Fit the model to the data using maximum likelihood estimation
efit <- sem(model, data = tpdf)

```


